# スマホアプリ「デビカン」 機能設計書

## 1. 文書概要
- 目的: 本書は要件定義書の機能要件をもとに、画面構成・振る舞い・データ操作の具体的な仕様を示す。
- 対象読者: プロダクトオーナー、デザイナー、フロントエンド／バックエンド開発者、テスター。
- 関連文書: `要件定義書.md`, `テーブル定義書.md`。

## 2. システム概要
- プラットフォーム: iOS / Android (React Native)。
- データ保存: 端末ローカル SQLite、接続はアプリ内ラッパーを介して実装。
- シングルユーザー前提。ログイン機構は持たない。
- オフライン常時利用を想定し、非同期処理は全てローカル完結。

## 3. 画面構成

### 3.1 画面一覧
| 画面ID | 画面名 | 役割 | 遷移元 | 遷移先 |
| --- | --- | --- | --- | --- |
| SCR-01 | ホーム画面 | 月次金額入力、引き落とし予定表示、口座別サマリーを集約 | アプリ起動 | SCR-02, SCR-03 |
| SCR-02 | 支払項目管理画面 | 支払項目の一覧・登録・編集 | SCR-01 | SCR-04 |
| SCR-03 | 設定モーダル | アプリ情報表示 | SCR-01 | なし (閉じる) |
| SCR-04 | 支払項目編集モーダル | 項目編集・削除確認 | SCR-02 | なし (閉じる) |

### 3.2 画面遷移仕様
- アプリ起動時にSCR-01を表示する。
- SCR-01の「支払項目管理」ボタンでSCR-02へ遷移する。
- SCR-02で「新規作成」押下時はモーダルとして編集フォームを表示 (SCR-04)。
- SCR-02のリスト行タップで同モーダルを編集モードで開く。
- SCR-01のヘッダー右上の歯車アイコンでSCR-03をモーダル表示する。
- モーダルは全てスクリーン全体を覆う半透明オーバーレイで閉じるボタンを持つ。

## 4. 機能詳細

### 4.1 支払項目管理機能 (SCR-02, SCR-04)
#### 概要
- ユーザーが管理対象の支払項目をCRUD操作できるようにする。

#### 画面要素
| 要素 | 種別 | 必須 | 検証・挙動 |
| --- | --- | --- | --- |
| 項目名テキストフィールド | TextInput | 〇 | 1以上50文字まで。先頭・末尾の空白をトリム。|
| 引き落とし口座テキストフィールド | TextInput | 〇 | 1以上50文字まで。同一名称を許容。|
| デフォルト引き落とし日セレクタ | Picker | 任意 | 1〜28の整数。未選択時は null 保存。|
| 保存ボタン | Button | - | 必須項目が未入力の場合は非活性。|
| キャンセルボタン | Button | - | 押下でモーダルを閉じる。|
| 削除ボタン | Button | - | 編集モードのみ表示。押下で確認ダイアログ。|
| 削除確認ダイアログ | Dialog | - | メッセージ「関連する月次データもすべて削除されます。よろしいですか？」、ボタン「削除」「キャンセル」。|

#### 処理フロー
1. 新規作成時はフォームを初期化し、保存ボタンは非活性。
2. 必須入力が埋まると保存ボタンを活性化し、押下で以下を実行。
   - 入力値を再度検証。
   - `payment_items`テーブルにINSERT／UPDATE。
   - 成功後にモーダルを閉じ、SCR-02の一覧を再取得。
3. 削除ボタン押下時は確認ダイアログを表示し、承認された場合は対象の`payment_items`レコードをDELETEした後、モーダルを閉じて一覧を再取得。外部キー制約により関連する`monthly_payments`レコードも同時に削除される。
4. SQLite操作中はローディングインジケーターをスクリーン中央に表示。

#### エラー処理
- バリデーションエラーは各入力の下に赤字テキストで表示。
- DB操作が失敗した場合はトーストで「保存に失敗しました。再度お試しください。」を表示。

### 4.2 月次支払管理機能 (SCR-01)
#### 概要
- ホーム画面で対象月の各支払項目に対する予定日・金額・支払状況を一覧管理する。

#### 画面要素
| 要素 | 種別 | 必須 | 検証・挙動 |
| --- | --- | --- | --- |
| 月切替ボタン (前月/次月) | Button | - | 押下で対象月を変更し、一覧とサマリーを再描画。|
| 支払項目リスト | FlatList | - | 登録済み項目を日付昇順で表示。項目が0件の場合は案内メッセージを表示。|
| 引き落とし日表示/編集 | TouchableOpacity + DatePicker | 〇 | 行内の表示をタップで日付選択。デフォルト日は項目設定値があれば反映。|
| 金額入力欄 | TextInput | 〇 | 0以上の数値。未入力にすると空欄表示、保存時は0として扱い表示側で空欄に戻す。|
| 支払完了チェック | CheckBox | - | 状態変更で即時保存。完了時は行のスタイルを変更。|

#### 処理フロー
1. 画面フォーカス時および月切替時に`payment_items`と対象月の`monthly_payments`を取得してマージする。
2. 各行の金額入力はデバウンス保存し、`monthly_payments`にINSERT/UPDATEする。空文字は0として保存し、表示では空欄に戻す。
3. 日付変更は日付ピッカー選択で即時保存する。
4. 支払完了チェックはトグル操作で直ちに保存し、表示リストを更新する。

#### エラー処理
- DB処理失敗時はトーストで通知。保存失敗時はローカル状態を元に戻す検討が必要。
- 日付ピッカーキャンセル時は既存値を維持する。

### 4.3 口座別サマリー機能 (SCR-01)
#### 概要
- 未払いの支払予定から口座ごとの入金必要額と期限を算出する。

#### 表示仕様
- 未払い (`is_paid = false`) のレコードのみ集計。
- グルーピングキー: 引き落とし口座。
- 各口座の表示順は引き落とし最短日が早い順。
- 口座ブロック内では、日付昇順の明細リストと最終行に太字で「→ {最終日}までに合計 ¥{総額} が必要」を表示。
- 金額は3桁区切りで表示。
- 対象口座が0件の場合はブロックを表示せず、「未払いの予定はありません。」のメッセージを表示。

#### 処理ロジック
1. 予定リスト取得後にメモリ内でフィルタリングと集計を実施。
2. 月切替やチェック状態更新時に再計算。

### 4.4 設定機能 (SCR-03)
#### 概要
- アプリ情報をモーダルで表示するシンプルな設定画面。

#### 画面要素
| 要素 | 種別 | 挙動 |
| --- | --- | --- |
| アプリ情報カード | View | タイトル「debikanについて」、本文にバージョン(v0.1)とコピーライトを表示。|
| 閉じるボタン | Button | 押下でモーダルを閉じる。|

#### 挙動
- モーダル背景タップまたはスワイプダウンでも閉じられるようにする (OS標準挙動に準拠)。

## 5. 共通仕様
- 日付操作は端末ローカルタイムゾーンを採用。
- 通貨表示は日本円固定。入力金額は数値のみ受け付け、表示時に`¥`と区切りを付与。
- ローディングインジケーターはグローバルコンポーネントを用意し、DBアクセス時に画面単位で利用。
- トーストは最大1件まで同時表示とし、既存表示中に新規通知が来た場合は置き換え。

## 6. データ操作仕様
| 操作 | 対象テーブル | 主なカラム | 備考 |
| --- | --- | --- | --- |
| 支払項目一覧取得 | `payment_items` | `id`, `name`, `default_due_day`, `account_name` | すべての画面で同一のリポジトリ関数を使用。|
| 支払項目登録/更新 | `payment_items` | 上記 + `created_at`, `updated_at` | 変更日時はアプリ側でISO文字列を生成。|
| 支払項目削除 | `payment_items` | `id` | 物理削除。外部キー制約により紐づく`monthly_payments`が自動削除される。|
| 月次予定取得 | `monthly_payments` | `id`, `payment_item_id`, `scheduled_on`, `amount`, `is_paid` | 月（月初〜月末）で範囲検索。|
| 月次予定登録/更新 | `monthly_payments` | 同上 | 同一項目・日付はUPDATE、それ以外はINSERT。削除フローは未実装。|

## 7. テスト観点メモ
- バリデーション: 必須/桁数/形式、上書き確認フロー。
- 月切替: 境界値 (1月→12月) の移動、前月・次月連打時のパフォーマンス。
- 集計: 未払いのみ集計されるか、金額フォーマット確認。

## 8. 今後の拡張余地
- データバックアップ機能追加時は設定画面にエクスポート/インポート項目を配置予定。
- 通知機能実装時はローカル通知のスケジュール連携が必要。
